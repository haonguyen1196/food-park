name: Laravel

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Sử dụng SQLite cho bước build nhằm tránh lỗi kết nối DB trong quá trình chạy composer và artisan package:discover.
    env:
      DB_CONNECTION: sqlite
      DB_DATABASE: database/database.sqlite

    steps:
      # 👉 Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer, npm

      # 👉 Clone code từ GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # 👉 Tạo file database SQLite tạm thời cho môi trường CI/CD
      - name: Create temporary SQLite database
        run: |
          mkdir -p database
          touch database/database.sqlite

      # 👉 Cài đặt Laravel dependencies
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      # 👉 Generate APP_KEY nếu chưa có (các lệnh Artisan ở bước này sử dụng SQLite như đã cấu hình)
      - name: Generate application key
        run: php artisan key:generate --force

      # 👉 Thiết lập quyền cho folder storage & cache
      - name: Set directory permissions
        run: chmod -R 777 storage bootstrap/cache

      # 👉 Setup Node.js & build frontend với Vite
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend with Vite
        run: npm run build

      # 👉 Deploy lên CPanel bằng FTP
      - name: Deploy to CPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          local-dir: "./"
          server-dir: "/food-park"
          exclude: |
            **/.git*
            **/node_modules/*
            **/storage/*
            **/vendor/*
            .env

      # 👉 Chạy migrate database trên Hosting
      # Ở bước này, ta sử dụng các biến môi trường từ GitHub Secrets để kết nối đến DB trên hosting.
      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
