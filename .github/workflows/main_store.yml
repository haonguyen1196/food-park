name: Laravel

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ‘‰ Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          tools: composer, npm

      # ğŸ‘‰ Clone code tá»« GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ‘‰ Copy .env náº¿u chÆ°a cÃ³
      - name: Ensure .env exists
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"

      # ğŸ‘‰ CÃ i Ä‘áº·t Laravel dependencies
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      # ğŸ‘‰ Generate APP_KEY náº¿u chÆ°a cÃ³
      - name: Generate application key
        run: php artisan key:generate --force

      # ğŸ‘‰ Setup quyá»n folder storage & cache
      - name: Set directory permissions
        run: chmod -R 777 storage bootstrap/cache

      # ğŸ‘‰ Setup Node.js & build frontend vá»›i Vite
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend with Vite
        run: npm run build

      # ğŸ‘‰ Deploy lÃªn CPanel báº±ng FTP
      - name: Deploy to CPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: "./"
          server-dir: "/food-park"
          exclude: |
            **/.git*
            **/node_modules/*
            **/storage/*
            **/vendor/*
            .env

      # ğŸ‘‰ Cháº¡y migrate database trÃªn CPanel (náº¿u cáº§n)
      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
