name: Laravel

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Sá»­ dá»¥ng SQLite cho bÆ°á»›c build nháº±m trÃ¡nh lá»—i káº¿t ná»‘i DB trong quÃ¡ trÃ¬nh cháº¡y composer vÃ  artisan package:discover.
    env:
      DB_CONNECTION: sqlite
      DB_DATABASE: database/database.sqlite

    steps:
      # ğŸ‘‰ Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer, npm

      # ğŸ‘‰ Clone code tá»« GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ‘‰ Táº¡o file database SQLite táº¡m thá»i cho mÃ´i trÆ°á»ng CI/CD
      - name: Create temporary SQLite database
        run: |
          mkdir -p database
          touch database/database.sqlite

      # ğŸ‘‰ CÃ i Ä‘áº·t Laravel dependencies
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      # ğŸ‘‰ Generate APP_KEY náº¿u chÆ°a cÃ³ (cÃ¡c lá»‡nh Artisan á»Ÿ bÆ°á»›c nÃ y sá»­ dá»¥ng SQLite nhÆ° Ä‘Ã£ cáº¥u hÃ¬nh)
      - name: Generate application key
        run: php artisan key:generate --force

      # ğŸ‘‰ Thiáº¿t láº­p quyá»n cho folder storage & cache
      - name: Set directory permissions
        run: chmod -R 777 storage bootstrap/cache

      # ğŸ‘‰ Setup Node.js & build frontend vá»›i Vite
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend with Vite
        run: npm run build

      # ğŸ‘‰ Deploy lÃªn CPanel báº±ng FTP
      - name: Deploy to CPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          local-dir: "./"
          server-dir: "/food-park"
          exclude: |
            **/.git*
            **/node_modules/*
            **/storage/*
            **/vendor/*
            .env

      # ğŸ‘‰ Cháº¡y migrate database trÃªn Hosting
      # á» bÆ°á»›c nÃ y, ta sá»­ dá»¥ng cÃ¡c biáº¿n mÃ´i trÆ°á»ng tá»« GitHub Secrets Ä‘á»ƒ káº¿t ná»‘i Ä‘áº¿n DB trÃªn hosting.
      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
