name: Laravel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ‘‰ Clone code tá»« GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ‘‰ Setup PHP & Node.js
      - name: Setup PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # ğŸ‘‰ CÃ i Ä‘áº·t dependencies
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install frontend dependencies
        run: npm install

      # ğŸ‘‰ Build frontend
      - name: Build frontend with Vite
        run: npm run build

      # ğŸ‘‰ Thiáº¿t láº­p quyá»n cho storage & cache
      - name: Set directory permissions
        run: chmod -R 777 storage bootstrap/cache

      # ğŸ‘‰ Deploy lÃªn CPanel báº±ng FTP
      - name: Deploy to CPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          local-dir: "./"
          server-dir: "/food-park"
          exclude: |
            **/.git*
            **/node_modules/*
            **/storage/*
            **/vendor/*
            .env

      # ğŸ‘‰ Cháº¡y migrate database trÃªn server
      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
